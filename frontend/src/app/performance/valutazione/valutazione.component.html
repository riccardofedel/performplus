<div class="content">
  <div class="breadcrumb">
    <a [routerLink]="['/home']">{{ "home" | translate }}</a> -
    <a [routerLink]="['/performance']">{{ "performance" | translate }}</a>
  </div>
  <div class="title">{{ "valutazione" | translate }}</div>

  <performancebar page="valutazione"></performancebar>

  <!--
  <div class="p-3"
    *ngIf="!loading && !permissionService.getPermission(currentUser,Permission.OrganigrammaStruttura,true)">
    {{"no permesso"|translate}}
  </div>
-->
  <!-- <div *ngIf="permissionService.getPermission(currentUser,Permission.OrganigrammaStruttura,true)"> -->
  <div>
    <div class="maincnt">
      <span *ngIf="loading">
        <div class="loader">
          <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>
      </span>

      <div class="" *ngIf="cercaForm">
        <div
          class="d-flex flex-wrap align-items-center justify-content-center"
        ></div>
        <form [formGroup]="cercaForm">
          <div class="row mb-3">
            <div class="col-md-3">
              <label>{{ "valutato" | translate }}</label>
              <span>
                <label class="text-uppercase fs-4 fw-bold p-2">{{
                  nomeValutato
                }}</label>
              </span>
            </div>

            <div class="col-md-3">
              <label>{{ "valutatore" | translate }}</label>
              <ng-select
                id="idValutatore"
                bindLabel="cognome"
                bindValue="id"
                formControlName="idValutatore"
                (change)="onChangeValutatore($event)"
                [items]="valutatori"
                [clearable]=false
                placeholder=" "
              >
                <ng-template ng-option-tmp let-item="item">
                  <label>{{ item.cognome + " " + item.nome +" ["+item.codiceInterno+"]"}}</label>
                </ng-template>
                <ng-template ng-label-tmp let-item="item">
                  <span>{{ item.cognome + " " + item.nome +" ["+item.codiceInterno+"]"}}</span>
                </ng-template>
              </ng-select>
            </div>

            <div class="col-md-3">
              <label>{{ "valutazioni" | translate }}</label>
              <ng-select
                [id]="idRegistrazione"
                bindLabel="inizio"
                bindValue="idRegistrazione"
                [items]="registrazioni"
                formControlName="idRegistrazione"
                (change)="onChangeValutazione($event)"
                [clearable]="false"
                placeholder=" "
              >
                <ng-template ng-option-tmp let-item="item">
                  <label>{{
                    item.struttura + " " + item.fine
                  }}</label>
                </ng-template>
                <ng-template ng-label-tmp let-item="item">
                  <span>{{
                    item.struttura + " " + item.fine
                  }}</span>
                </ng-template>
              </ng-select>
            </div>
            <div class="col-md-3 text-end" *ngIf="idRegistrazione">
              <button
                *ngIf="registrazioni && registrazioni.length > 0"
                (click)="schedaValutato()"
                class="btn btn-primary mt-3"
                title="{{ 'totale schede valutato' | translate }}"
              >
                {{ "valutato" | translate }}</button
              >&nbsp;
              <button
                *ngIf="fase===1"
                [disabled]="!pubblicabile()"
                (click)="pubblicaScheda()"
                class="btn btn-primary mt-3"
                title="{{ tipoAccettazione | translate }}"
              >
                {{ "presa visione scheda" | translate }}</button
              >
              <button
                *ngIf="fase===2"
                [disabled]="!pubblicabile()"
                (click)="pubblicaValutazione()"
                class="btn btn-primary mt-3"
                title="{{ tipoAccettazione | translate }}"
              >
                {{ "presa visione valutazione" | translate }}</button
              >
              &nbsp;
              <button [disabled]="!stampabile && !idRegistrazione" class="btn btn-primary mt-3"
              (click)="stampa()">
                {{ "stampa valutazione" | translate }}</button
              >&nbsp;
            </div>
          </div>
        </form>
        <div *ngIf="scheda" class="row">
          <div class="col">
            <label class="control-label">{{'struttura' | translate}}</label>
            <p class="fw-bold text-primary">
            <label class="control-label">{{scheda.struttura}}</label>
            </p>
          </div>
         <div class="col">
            <label class=""control-label>{{'comportamenti' | translate}}</label>
            <p class="fw-bold text-primary">
            <label class="control-label">{{scheda.questionario}}</label>
            </p>
          </div>
         <div class="col">
            <label>{{'regolamento' | translate}}</label>
            <p class="fw-bold text-primary">
            <label class="fw-bold text-primary">{{scheda.regolamento}}</label>
            </p>
          </div>
          <div class="col">
            <label>{{'fine' | translate}}</label>
            <p class="fw-bold text-primary">
            <label class="fw-bold text-primary">{{ fieldsService.convertDate(scheda.fine)}}</label>
            </p>
          </div>
          <div class="col">
            <label>{{'responsabile' | translate}}</label>
            <p class="fw-bold text-primary">
            <label class="fw-bold text-primary">{{scheda.responsabile===true?'SI':'NO'}}</label>
            </p>
          </div>
          <div class="col">
            <label>{{'interim' | translate}}</label>
            <p class="fw-bold text-primary">
            <label class="fw-bold text-primary">{{scheda.interim===true?'SI':'NO'}}</label>
            </p>
          </div>
          <div class="col">
            <label>{{'po' | translate}}</label>
            <p class="fw-bold text-primary">
            <label class="fw-bold text-primary">{{scheda.po===true?'SI':'NO'}}</label>
            </p>
          </div>
          <div class="col" *ngIf="scheda.responsabile !==true">
            <label>{{'performance organizzativa' | translate}}</label>
            <p class="fw-bold text-primary">
            <label class="fw-bold text-primary">{{scheda.performanceOrganizzativa===true?'SI':'NO'}}</label>
            </p>
          </div>
          <div class="col" *ngIf="scheda.responsabile===true">
            <label>{{'mancata assegnazione' | translate}}</label>
            <p class="fw-bold text-primary">
            <label class="fw-bold text-primary">{{scheda.mancataAssegnazione===true?'SI':'NO'}}</label>
            </p>
          </div>
          <div class="col" *ngIf="scheda.responsabile===true">
            <label>{{'mancato colloquio' | translate}}</label>
            <p class="fw-bold text-primary">
            <label class="fw-bold text-primary">{{scheda.mancatoColloquio===true?'SI':'NO'}}</label>
            </p>
          </div>
         <div class="col">
            <label>{{'valutazione' | translate}}</label>
            <p class="fw-bold text-primary">
            <label class="fw-bold text-primary">{{scheda.valutazione}}</label>
            </p>
          </div>
        </div>
        <br/>
        <div *ngIf="idRegistrazione && this.statoScheda.dataPubblicazioneScheda">
          <div class="custom-tab-cnt">
            <div
              class="custom-tab"
              [ngClass]="{ active: selectedTab === 'obiettivi' }"
            >
              <a (click)="selectTab('obiettivi')">{{
                "valutazione obiettivi" | translate
              }}</a>
            </div>
            <div
              class="custom-tab"
              [ngClass]="{ active: selectedTab === 'risultato' }"
            >
              <a (click)="selectTab('risultato')">{{
                "valutazione risultato" | translate
              }}</a>
            </div>
            <div
              class="custom-tab"
              [ngClass]="{ active: selectedTab === 'totali' }"
            >
              <a (click)="selectTab('totali')">{{
                "valutazione totali" | translate
              }}</a>
            </div>
            <div
              class="custom-tab"
              [ngClass]="{ active: selectedTab === 'statoScheda' }"
            >
              <a (click)="selectTab('statoScheda')">{{
                "stato scheda" | translate
              }}</a>
            </div>
          </div>
          <div *ngIf="selectedTab == 'obiettivi'">
            <table
              class="table align-middle table-responsive table-big"
              *ngIf="!loading"
            >
              <thead *ngIf="scheda.performanceOrganizzativa === true">
                <tr>
                  <th scope="col" class="col-md-1">{{ "tipo" | translate }}</th>
                  <th scope="col" class="col-md-1">
                    {{ "peso obiettivo" | translate }}
                  </th>
                  <th scope="col" class="col-md-1">
                    {{ "raggiungimento %" | translate }}
                  </th>
                  <th scope="col" class="col-md-1">
                    {{ "totale" | translate }}
                  </th>
                </tr>
              </thead>
              <thead *ngIf="scheda.performanceOrganizzativa !== true">
                <tr>
                  <!-- <th scope="col" class="col-md-1">
                    {{ "struttura" | translate }}
                  </th> -->
                  <th scope="col" class="col-md-2">
                    {{ "obiettivo" | translate }}
                  </th>
                  <th scope="col" class="col-md-1">
                    {{ "tipologia" | translate }}
                  </th>

                  <th scope="col" class="col-md-2">
                    {{ "indicatore" | translate }}
                  </th>
                  <th scope="col" class="col-md-1">
                    {{ "scadenza" | translate }}
                  </th>
                  <th scope="col" class="col-md-1">{{ "tipo" | translate }}</th>
                  <th scope="col" class="col-md-1">
                    {{ "peso obiettivo" | translate }}
                  </th>
                  <th scope="col" class="col-md-1">
                    {{ "peso indicatore" | translate }}
                  </th>
                  <th scope="col" class="col-md-1">
                    {{ "target" | translate }}
                  </th>
                  <th scope="col" class="col-md-1">
                    {{ "raggiungimento %" | translate }}
                  </th>
                  <th scope="col" class="col-md-1">
                    {{ "totale" | translate }}
                  </th>
                  <th scope="col" class="col-md-2">{{ "note" | translate }}</th>
                </tr>
              </thead>
              <tbody *ngIf="scheda.performanceOrganizzativa === true">
                <tr
                  *ngFor="let item of obiettivi; let i = index"
                  class="oddRow"
                >
                  <td>
                    {{'performance organizzativa' | translate}}
                  </td>
                  <td>
                    {{ item.pesoObiettivo + "%" }}
                  </td>
                  <td>
                    {{ item.raggiungimentoObiettivo + "%" }}
                  </td>
                  <td>
                    {{ item.valutazioneObiettivo + "%" }}
                  </td>
                </tr>
              </tbody>
              <tbody *ngIf="scheda.performanceOrganizzativa !== true">
                <tr
                  *ngFor="let item of obiettivi; let i = index"
                  [ngClass]="{
                    oddRow: item.idSchedaValutazioneObiettivo ? 0 : 1
                  }"
                >
                  <!-- <td>{{ item.idStruttura ? item.struttura : "" }}</td> -->
                  <td>
                    {{
                      item.idSchedaValutazioneObiettivo ? item.obiettivo : ""
                    }}
                  </td>
                  <td>
                    {{
                      item.idSchedaValutazioneObiettivo
                        ? item.tipoObiettivo
                        : ""
                    }}
                  </td>
                  <td>
                    {{
                      item.idSchedaValutazioneIndicatore ? item.indicatore : ""
                    }}
                  </td>
                  <td>
                    {{
                      item.idSchedaValutazioneObiettivo
                        ? fieldsService.convertDate(item.scadenza)
                        : item.idSchedaValutazioneIndicatore
                        ? fieldsService.convertDate(item.scadenzaIndicatore)
                        : ""
                    }}
                  </td>
                  <td>
                    {{
                      item.idSchedaValutazioneObiettivo
                        ? item.tipoRegolamento
                        : ""
                    }}
                  </td>
                  <td>
                    {{
                      item.idSchedaValutazioneObiettivo
                        ? item.pesoObiettivo + "%"
                        : ""
                    }}
                  </td>
                  <td>
                    {{
                      item.idSchedaValutazioneIndicatore
                        ? item.pesoIndicatore + "%"
                        : ""
                    }}
                  </td>
                  <td>
                    {{ item.idSchedaValutazioneIndicatore ? item.target : "" }}
                  </td>
                  <td>
                    {{
                      item.idSchedaValutazioneIndicatore
                        ? item.raggiungimentoIndicatore + "%"
                        : ""
                    }}
                  </td>
                  <td>
                    {{
                      item.idStruttura
                        ? ""
                        : item.idSchedaValutazioneIndicatore
                        ? item.valutazioneIndicatore + "%"
                        : ""
                    }}
                  </td>
                  <td>
                    {{
                      item.idSchedaValutazioneIndicatore
                        ? item.noteForzaturaIndicatore
                        : ""
                    }}
                  </td>
                </tr>
              </tbody>
            </table>

            <pagination
              *ngIf="!loading && scheda.performanceOrganizzativa !== true"
              [paginationService]="paginationService"
              class="flex-shrink-1"
            ></pagination>
          </div>

          <div *ngIf="selectedTab == 'risultato'">
            <table
              class="table align-middle table-responsive table-big"
              *ngIf="!loading"
            >
              <thead class="bg-light">
                <tr>
                  <th>{{ "domanda" | translate }}</th>
                  <th>{{ "risposta" | translate }}</th>
                  <th>{{ "valore" | translate }}</th>
                </tr>
              </thead>
              <tbody *ngIf="risultato?.items">
                <tr
                  *ngFor="let item of risultato?.items; let i = index"
                  [ngClass]="{
                    'bordo-rosso': !item.risposta && i,
                    oddRow: item.odd
                  }"
                >
                  <td>
                    {{ item.risposta ? "" : item.descrizione }}
                  </td>
                  <td>
                    {{ item.risposta ? item.descrizione : "" }}
                  </td>
                  <td>
                    {{ item.risposta ? item.peso + "%" : "" }}
                  </td>
                </tr>
                <tr>
                  <td class="font-weight-bold">
                    <b>{{ "risultato comportamento" | translate }}</b>
                  </td>
                  <td></td>
                  <td class="font-weight-bold">
                    <b
                      >{{
                        risultato.raggiungimentoQuestionario == null
                          ? 0
                          : risultato.raggiungimentoQuestionario
                      }}%</b
                    >
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <div *ngIf="selectedTab == 'totali'">
            <table
              class="table align-middle table-responsive table-big"
              *ngIf="!loading"
            >
              <thead class="bg-light">
                <tr>
                  <th></th>
                  <th>{{ "peso" | translate }}</th>
                  <th>{{ "valutazione" | translate }}</th>
                </tr>
              </thead>
              <tbody *ngIf="totali?.items">
                <tr *ngFor="let item of totali?.items; let i = index">
                  <td [ngClass]="{ 'fw-bold': item.livello == 0 }">
                    {{ item.denominazione }}
                  </td>

                  <td class="fst-italic">
                    {{ item.peso ? item.peso + "%" : "" }}
                  </td>
                  <td [ngClass]="{ 'fw-bold': item.livello == 0 }">
                    {{ item.valutazione ? item.valutazione + "%" : "" }}
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <div *ngIf="selectedTab == 'statoScheda'">
            <table
              class="table align-middle table-responsive table-big"
              *ngIf="!loading"
            >
              <thead>
                <tr>
                  <th class="h-2"></th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td colspan="2" class="fw-bold px-2">
                    {{ "FASE ASSEGNAZIONE OBIETTIVI" | translate }}
                  </td>
                </tr>
                <tr>
                  <td scope="row" class="col-2">
                    {{ "data invio" | translate }}
                  </td>
                  <td class="fw-bold">
                    {{
                      fieldsService.convertDate(
                        statoScheda?.dataPubblicazioneScheda
                      )
                    }}
                  </td>
                </tr>
                <tr>
                  <td scope="row">{{ "note valutatore" | translate }}</td>
                  <td class="fw-bold">
                    {{ statoScheda?.notePubblicazioneScheda }}
                  </td>
                </tr>
                <tr></tr>
                <tr>
                  <td scope="row">{{ "data presa visione" | translate }}</td>
                  <td class="fw-bold">
                    {{
                      fieldsService.convertDate(
                        statoScheda?.dataAccettazioneScheda
                      )
                    }}
                  </td>
                </tr>
                <tr>
                  <td scope="row">{{ "note valutato" | translate }}</td>
                  <td class="fw-bold">
                    {{ statoScheda?.noteAccettazioneScheda }}
                  </td>
                </tr>
                <tr></tr>
                <tr></tr>
                <tr>
                  <td colspan="2" class="fw-bold sm-2">
                    {{ "FASE VALUTAZIONE" | translate }}
                  </td>
                </tr>
                <tr>
                  <td scope="row">{{ "data invio" | translate }}</td>
                  <td class="fw-bold">
                    {{
                      fieldsService.convertDate(
                        statoScheda?.dataPubblicazioneValutazione
                      )
                    }}
                  </td>
                </tr>
                <tr>
                  <td scope="row">{{ "note valutatore" | translate }}</td>
                  <td class="fw-bold">
                    {{ statoScheda?.notePubblicazioneValutazione }}
                  </td>
                </tr>
                <tr></tr>
                <tr>
                  <td scope="row">{{ "data presa visione" | translate }}</td>
                  <td class="fw-bold">
                    {{
                      fieldsService.convertDate(
                        statoScheda?.dataAccettazioneValutazione
                      )
                    }}
                  </td>
                </tr>
                <tr>
                  <td scope="row">{{ "note valutato" | translate }}</td>
                  <td class="fw-bold">
                    {{ statoScheda?.noteAccettazioneValutazione }}
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <!--content-->
    </div>
  </div>
</div>
